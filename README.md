# 📊 Employee Health Tracking System

Система для отслеживания состояния здоровья сотрудников с интеграцией Telegram бота и REST API, включающая автоматическое планирование дежурств администраторов.

## 🚀 Возможности

### 🤖 Telegram Бот

- **Регистрация сотрудников** - простой процесс регистрации через бота
- **Отметка статуса здоровья** - быстрое обновление статуса (здоров, болен, отпуск и т.д.)
- **Просмотр отчетов** - отчеты по секторам в реальном времени
- **Административная панель** - управление пользователями и правами
- **Поиск сотрудников** - поиск по имени, фамилии или username
- **👨‍✈️ Управление дежурствами** - новая система планирования дежурных администраторов

### 👨‍✈️ Система дежурных администраторов

- **Пул дежурных** - создание списка администраторов, готовых к дежурству
- **Автоматическое назначение** - система сама выбирает дежурного на неделю с учетом:
  - Количества отработанных смен в году
  - Даты последнего дежурства
  - Равномерного распределения нагрузки
- **Ручное управление** - добавление и удаление администраторов из пула
- **Расписание** - просмотр дежурств на сегодня, неделю или месяц
- **Статистика** - аналитика по отработанным сменам для каждого администратора
- **Справедливое распределение** - алгоритм минимизирует дисбаланс нагрузки

### 🌐 REST API

- **Полноценный CRUD** - для всех сущностей системы
- **Отчеты** - генерация отчетов по секторам и статусам
- **Управление правами** - API для администрирования
- **Управление дежурствами** - полный набор эндпоинтов для системы дежурств
- **Асинхронные операции** - высокая производительность

### ⏰ Автоматизация

- **Рассылка отчетов** - автоматическая отправка по расписанию
- **Ежедневные отчеты** - настраиваемое время рассылки
- **Автоматическое назначение дежурств** - еженедельное планирование
- **Тестовые уведомления** - для отладки и тестирования

## 🏗️ Архитектура

```text
├── 📁 app/                    # FastAPI приложение
│   ├── 📁 api/routes/        # Маршруты API
│   │   ├── health.py         # Отчеты о здоровье
│   │   ├── users.py          # Управление пользователями
│   │   ├── admin.py          # Администрирование
│   │   └── duty.py           # 👨‍✈️ Управление дежурствами
│   ├── 📁 models/            # Модели БД (SQLAlchemy)
│   │   ├── user.py           # Пользователи, статусы, ФИО
│   │   ├── health.py         # Здоровье, заболевания
│   │   └── duty.py           # 👨‍✈️ Пул, расписание, статистика
│   ├── 📁 schemas/           # Pydantic схемы
│   ├── 📁 services/          # Бизнес-логика
│   │   ├── user_service.py   # Сервис пользователей
│   │   ├── health_service.py # Сервис здоровья
│   │   ├── admin_service.py  # Сервис администрирования
│   │   └── duty_service.py   # 👨‍✈️ Сервис дежурств
│   └── 📁 core/              # Конфигурация
│
├── 📁 bot/                    # Telegram бот
│   ├── 📁 handlers/          # Обработчики сообщений
│   │   ├── start.py          # Старт, регистрация, помощь
│   │   ├── health.py         # Отметка статуса здоровья
│   │   ├── report.py         # Отчеты
│   │   ├── admin.py          # Админ-панель
│   │   └── duty.py           # 👨‍✈️ Управление дежурствами
│   ├── 📁 keyboards/          # Клавиатуры бота
│   │   ├── main.py           # Основные клавиатуры
│   │   ├── admin.py          # Админские клавиатуры
│   │   └── duty.py           # 👨‍✈️ Клавиатуры дежурств
│   ├── 📁 services/           # Сервисы бота
│   ├── 📁 utils/              # Утилиты
│   └── 📁 scheduler/          # Планировщик задач
│
├── 📁 migrations/             # Миграции БД
├── 📄 requirements.txt        # Зависимости
├── 📄 main.py                 # Точка входа API
├── 📄 bot_runner.py           # Точка входа бота
└── 📄 .env                    # Конфигурация
```

## 🛠️ Технологии

- **Backend**: FastAPI, SQLAlchemy, Pydantic, Alembic
- **Database**: PostgreSQL 15+ с asyncpg
- **Telegram Bot**: Aiogram 3.x
- **Scheduler**: APScheduler
- **Async/await**: Полностью асинхронная архитектура
- **Environment**: Python 3.10+
- **Containerization**: Docker, Docker Compose
- **Database functions**: PL/pgSQL для сложной логики (назначение дежурств)

## 📦 Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd bot_health
```

### 2. Настройка окружения

```bash
# Копируем пример конфигурации
cp .env.example .env

# Редактируем .env файл
nano .env
```

### 3. Настройка переменных окружения (.env)

```env
# Database
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=health_tracker

# Telegram
TELEGRAM_TOKEN=your_bot_token_here

# API
SECRET_KEY=your_secret_key_here
API_BASE_URL=http://localhost:8000

# Scheduler
REPORT_TIME=07:30
REPORT_TIMEZONE=Europe/Moscow
```

### 4. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 5. Инициализация базы данных

```bash
# База данных создастся автоматически при первом запуске API
python main.py
# Или используйте миграции:
python migrations/manage.py up
```

### 6. Запуск приложений

**Запуск REST API:**

```bash
python main.py
```

API будет доступен по адресу: <http://localhost:8000>
Документация Swagger: <http://localhost:8000/docs>

**Запуск Telegram бота:**

```bash
python bot_runner.py
```

### 7. Деплой в Docker

```bash
# Разработка
docker-compose -f docker-compose.dev.yml up -d

# Продакшн
docker-compose -f docker-compose.prod.yml up -d
```

## 📋 Основные команды бота

### Для всех пользователей

| Команда / Кнопка | Описание |
|------------------|----------|
| `/start` | Начало работы, регистрация |
| `/help` | Справка по командам |
| `📊 Отчет по моему сектору` | Просмотр отчета |
| `💊 Отметить статус здоровья` | Изменить свой статус |
| `👤 Моя информация` | Информация о пользователе |

### Для администраторов

| Команда / Кнопка | Описание |
|------------------|----------|
| `👑 Админ панель` | Вход в панель управления |
| `👨‍✈️ Управление дежурствами` | Вход в систему дежурств |
| `🔍 Найти сотрудника` | Поиск по имени или ID |
| `📋 Статистика` | Общая статистика системы |
| `/users` | Список всех пользователей |
| `/user_info ID` | Информация о пользователе |
| `/sector_report ID` | Отчет по сектору |
| `/toggle_admin ID` | Дать/забрать админ права |

### 👨‍✈️ Команды управления дежурствами (в меню)

| Кнопка | Описание |
|--------|----------|
| `📋 Пул дежурных` | Просмотр списка дежурных в секторе |
| `➕ Добавить в пул` | Добавить администратора в пул |
| `➖ Удалить из пула` | Удалить администратора из пула |
| `📅 Назначить на неделю` | Автоматическое назначение дежурного |
| `👤 Дежурный сегодня` | Кто дежурит сегодня |
| `📊 Статистика сектора` | Аналитика по дежурствам |

## 🔧 API Endpoints

### Пользователи (`/users`)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/users/` | Список пользователей |
| GET | `/users/{user_id}` | Информация о пользователе |
| POST | `/users/` | Создание пользователя |
| PUT | `/users/{user_id}` | Обновление пользователя |
| GET | `/users/search/` | Поиск пользователей |
| GET | `/users/admin/list` | Список для админ-панели |

### Отчеты о здоровье (`/health`)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/health/report` | Отчет по статусам |
| PUT | `/users/{user_id}/health` | Обновление статуса |
| GET | `/health/sectors` | Список секторов |

### Администрирование (`/admin`)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| PUT | `/admin/users/{user_id}/toggle-report` | Вкл/выкл отчеты |
| PUT | `/admin/users/{user_id}/toggle-admin` | Вкл/выкл админа |

### 👨‍✈️ Управление дежурствами (`/duty`)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/duty/pool` | Добавить в пул |
| DELETE | `/duty/pool/{user_id}/{sector_id}` | Удалить из пула |
| GET | `/duty/pool/sector/{sector_id}` | Пул сектора |
| POST | `/duty/assign-weekly` | Назначить на неделю |
| GET | `/duty/schedule` | Расписание |
| GET | `/duty/schedule/today` | Дежурный сегодня |
| GET | `/duty/statistics` | Статистика |
| GET | `/duty/statistics/sector/{sector_id}/summary` | Сводка по сектору |

## 🗄️ Структура базы данных

### Основные таблицы

| Таблица | Назначение |
|---------|------------|
| `users` | Основная информация о пользователях |
| `id_status` | Статусы и права пользователей |
| `fio` | ФИО пользователей |
| `health` | Статусы здоровья |
| `disease` | Заболевания |
| `sectors` | Сектора/отделы |

### 👨‍✈️ Таблицы дежурств

| Таблица | Назначение |
|---------|------------|
| `duty_admin_pool` | Пул дежурных администраторов |
| `duty_schedule` | Расписание дежурств |
| `duty_statistics` | Статистика по годам |

### Функции PostgreSQL

| Функция | Назначение |
|---------|------------|
| `assign_weekly_duty_admin` | Автоматическое назначение дежурного на неделю |
| `get_sector_duty_stats` | Получение статистики по сектору |
| `get_monthly_duty_schedule` | Расписание на месяц |

## ⚙️ Настройка рассылки отчетов

### Через переменные окружения

```env
REPORT_TIME=07:30          # Время ежедневной рассылки
REPORT_DAYS=0,1,2,3,4      # Дни недели (0=понедельник)
REPORT_ENABLED=true        # Включить/выключить
```

### Через команды бота

```bash
/test_schedule     # Тестовая рассылка
/schedule_info     # Информация о расписании
```

## 🧪 Тестирование

### Запуск тестов API

```bash
pytest tests/ -v
```

### Тестовая рассылка

```bash
# В боте используйте команду
/test_schedule
```

### Проверка системы дежурств

1. В админ-панели выберите "👨‍✈️ Управление дежурствами"
2. Добавьте несколько администраторов в пул
3. Назначьте дежурство на неделю
4. Проверьте статистику и расписание

## 🔒 Безопасность

- JWT аутентификация (в разработке)
- Валидация всех входных данных через Pydantic
- Защита от SQL-инъекций через ORM и параметризованные запросы
- Разделение прав пользователей и администраторов
- Мягкое удаление (деактивация) вместо физического удаления

## 📈 Мониторинг и логирование

- Подробное логирование всех операций
- Отслеживание ошибок и исключений
- Мониторинг производительности API
- Логи рассылки отчетов
- Логи автоматического назначения дежурств

## 🔄 Миграции базы данных

```bash
# Применить миграции
python migrations/manage.py up

# Откатить миграции
python migrations/manage.py down

# Показать статус
python migrations/manage.py status

# Создать новую миграцию
alembic revision --autogenerate -m "description"
```

## 🐳 Windows Development & Production Deployment

### Быстрый старт на Windows

```powershell
# Запустить как администратор в PowerShell
.\init-windows.ps1

# Запустить разработку
.\deploy.ps1 -Build

# Управление сервисами
.\manage.ps1 start
.\manage.ps1 stop
.\manage.ps1 logs
.\manage.ps1 migrate
```

### Доступ к сервисам

| Сервис | URL | Логин/Пароль |
|--------|-----|--------------|
| API | <http://localhost:8000> | - |
| API Docs | <http://localhost:8000/docs> | - |
| PgAdmin | <http://localhost:5050> | <dev@example.com> / dev_password |

### Деплой на Linux сервер

```powershell
# Настройка сервера
.\deploy-linux.ps1 -Server your-server.com -Username ubuntu -Setup

# Деплой приложения
.\deploy-linux.ps1 -Server your-server.com -Username ubuntu
```

## 🤝 Вклад в проект

1. Форкните репозиторий
2. Создайте ветку для новой функции (`git checkout -b feature/amazing-feature`)
3. Зафиксируйте изменения (`git commit -m 'Add amazing feature'`)
4. Запушьте в ветку (`git push origin feature/amazing-feature`)
5. Откройте Pull Request

## 📄 Лицензия

Этот проект распространяется под лицензией MIT. Смотрите файл `LICENSE` для подробностей.

## 📞 Поддержка

При возникновении проблем:

1. Проверьте логи приложения
2. Убедитесь что все службы запущены
3. Проверьте настройки в `.env` файле
4. Создайте Issue в репозитории

## 🎯 Быстрый старт для разработчиков

```bash
# 1. Клонируйте проект
git clone <repo>

# 2. Настройте окружение
cp .env.example .env
# отредактируйте .env

# 3. Установите зависимости
pip install -r requirements.txt

# 4. Запустите в двух терминалах:
# Терминал 1: API сервер
python main.py

# Терминал 2: Telegram бот
python bot_runner.py
```

**Примечание:** Убедитесь что PostgreSQL запущен и доступен по указанным в `.env` параметрам.

---

⭐ **Если проект вам понравился, поставьте звездочку на GitHub!** ⭐

```text

## Основные изменения в README.md:

1. **Добавлен раздел "👨‍✈️ Система дежурных администраторов"** - подробно описывает функционал

2. **Обновлена архитектура** - добавлены новые файлы и модули:
   - `duty.py` в routes
   - `duty.py` в models
   - `duty_service.py` в services
   - `duty.py` в handlers и keyboards бота

3. **Добавлены команды бота для дежурств** - в раздел с таблицей

4. **Добавлены API эндпоинты для дежурств** - новая таблица с методами `/duty/*`

5. **Обновлена структура БД** - добавлены таблицы дежурств и функции PostgreSQL

6. **Добавлен раздел с функциями PostgreSQL** - `assign_weekly_duty_admin`, `get_sector_duty_stats` и др.

7. **Обновлен раздел тестирования** - добавлена проверка системы дежурств

8. **Добавлены новые технологии** - PL/pgSQL, Alembic

Этот README теперь полностью отражает функционал системы, включая новую подсистему дежурств.
