# 📊 Employee Health Tracking System

Система для отслеживания состояния здоровья сотрудников с интеграцией Telegram бота и REST API.

## 🚀 Возможности

### 🤖 Telegram Бот
- **Регистрация сотрудников** - простой процесс регистрации через бота
- **Отметка статуса здоровья** - быстрое обновление статуса (здоров, болен, отпуск и т.д.)
- **Просмотр отчетов** - отчеты по секторам в реальном времени
- **Административная панель** - управление пользователями и правами
- **Поиск сотрудников** - поиск по имени, фамилии или username

### 🌐 REST API
- **Полноценный CRUD** - для всех сущностей системы
- **Отчеты** - генерация отчетов по секторам и статусам
- **Управление правами** - API для администрирования
- **Асинхронные операции** - высокая производительность

### ⏰ Автоматизация
- **Рассылка отчетов** - автоматическая отправка по расписанию
- **Ежедневные отчеты** - настраиваемое время рассылки
- **Тестовые уведомления** - для отладки и тестирования

## 🏗️ Архитектура

```
├── 📁 app/                    # FastAPI приложение
│   ├── 📁 api/routes/        # Маршруты API
│   ├── 📁 models/            # Модели БД (SQLAlchemy)
│   ├── 📁 schemas/           # Pydantic схемы
│   ├── 📁 services/          # Бизнес-логика
│   └── 📁 core/              # Конфигурация
│
├── 📁 bot/                   # Telegram бот
│   ├── 📁 handlers/          # Обработчики сообщений
│   ├── 📁 keyboards/         # Клавиатуры бота
│   ├── 📁 services/          # Сервисы бота
│   ├── 📁 utils/             # Утилиты
│   └── 📁 scheduler/         # Планировщик задач
│
├── 📁 migrations/            # Миграции БД
├── 📄 requirements.txt       # Зависимости
├── 📄 main.py               # Точка входа API
├── 📄 bot_runner.py         # Точка входа бота
└── 📄 .env                  # Конфигурация
```

## 🛠️ Технологии

- **Backend**: FastAPI, SQLAlchemy, Pydantic
- **Database**: PostgreSQL с asyncpg
- **Telegram Bot**: Aiogram 3.x
- **Scheduler**: APScheduler
- **Async/await**: Полностью асинхронная архитектура
- **Environment**: Python 3.10+

## 📦 Установка и запуск

### 1. Клонирование репозитория
```bash
git clone <repository-url>
cd bot_health
```

### 2. Настройка окружения
```bash
# Копируем пример конфигурации
cp .env.example .env

# Редактируем .env файл
nano .env
```

### 3. Настройка переменных окружения (.env)
```env
# Database
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=health_tracker

# Telegram
TELEGRAM_TOKEN=your_bot_token_here

# API
SECRET_KEY=your_secret_key_here
API_BASE_URL=http://localhost:8000

# Scheduler
REPORT_TIME=07:30
REPORT_TIMEZONE=Europe/Moscow
```

### 4. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 5. Инициализация базы данных
```bash
# Создание и настройка БД
python migrations/manage.py up
```

### 6. Запуск приложений

**Запуск REST API:**
```bash
python main.py
```
API будет доступен по адресу: http://localhost:8000
Документация Swagger: http://localhost:8000/docs

**Запуск Telegram бота:**
```bash
python bot_runner.py
```

### 7. Деплой в Docker (опционально)
```bash
docker-compose up -d
```

## 📋 Основные команды бота

### Для всех пользователей:
- `/start` - Начало работы, регистрация
- `/help` - Справка по командам
- `📊 Отчет по моему сектору` - Просмотр отчета
- `💊 Отметить статус здоровья` - Изменить свой статус
- `👤 Моя информация` - Информация о пользователе

### Для администраторов:
- `👑 Админ панель` - Панель управления
- `/users` - Список всех пользователей
- `/search Иванов` - Поиск пользователей
- `/user_info ID` - Информация о пользователе
- `/sector_report ID` - Отчет по сектору
- `/toggle_admin ID` - Дать/забрать админ права
- `/test_schedule` - Тест рассылки отчетов

## 🔧 API Endpoints

### Пользователи
- `GET /users/` - Список пользователей
- `GET /users/{user_id}` - Информация о пользователе
- `POST /users/` - Создание пользователя
- `PUT /users/{user_id}` - Обновление пользователя
- `GET /users/search/` - Поиск пользователей

### Отчеты о здоровье
- `GET /health/report` - Отчет по статусам
- `PUT /users/{user_id}/health` - Обновление статуса
- `GET /health/sectors` - Список секторов

### Администрирование
- `PUT /admin/users/{user_id}/toggle-report` - Вкл/выкл отчеты
- `PUT /admin/users/{user_id}/toggle-admin` - Вкл/выкл админа

## 🗄️ Структура базы данных

```sql
users          - Основная информация о пользователях
id_status      - Статусы и права пользователей
fio            - ФИО пользователей
health         - Статусы здоровья
disease        - Заболевания
sectors        - Сектора/отделы
```

## ⚙️ Настройка рассылки отчетов

### Через переменные окружения:
```env
REPORT_TIME=07:30          # Время ежедневной рассылки
REPORT_DAYS=0,1,2,3,4      # Дни недели (0=понедельник)
REPORT_ENABLED=true        # Включить/выключить
```

### Через команды бота:
```bash
/test_schedule     # Тестовая рассылка
/schedule_info     # Информация о расписании
```

## 🧪 Тестирование

### Запуск тестов API:
```bash
pytest tests/ -v
```

### Тестовая рассылка:
```bash
# В боте используйте команду
/test_schedule
```

### Проверка работоспособности:
1. Откройте http://localhost:8000/docs для проверки API
2. Найдите бота в Telegram и отправьте `/start`
3. Проверьте регистрацию и основные функции

## 🔒 Безопасность

- JWT аутентификация (в разработке)
- Валидация всех входных данных
- Защита от SQL-инъекций через ORM
- Разделение прав пользователей и администраторов

## 📈 Мониторинг и логирование

- Подробное логирование всех операций
- Отслеживание ошибок и исключений
- Мониторинг производительности API
- Логи рассылки отчетов

## 🔄 Миграции базы данных

```bash
# Применить миграции
python migrations/manage.py up

# Откатить миграции
python migrations/manage.py down

# Показать статус
python migrations/manage.py status
```

## 🤝 Вклад в проект

1. Форкните репозиторий
2. Создайте ветку для новой функции (`git checkout -b feature/amazing-feature`)
3. Зафиксируйте изменения (`git commit -m 'Add amazing feature'`)
4. Запушьте в ветку (`git push origin feature/amazing-feature`)
5. Откройте Pull Request

## 📄 Лицензия

Этот проект распространяется под лицензией MIT. Смотрите файл `LICENSE` для подробностей.

## 📞 Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь что все службы запущены
3. Проверьте настройки в `.env` файле
4. Создайте Issue в репозитории

## 🎯 Быстрый старт для разработчиков

```bash
# 1. Клонируйте проект
git clone <repo>

# 2. Настройте окружение
cp .env.example .env
# отредактируйте .env

# 3. Установите зависимости
pip install -r requirements.txt

# 4. Инициализируйте БД
python migrations/manage.py up

# 5. Запустите в двух терминалах:
# Терминал 1: API сервер
python main.py

# Терминал 2: Telegram бот
python bot_runner.py
```

**Примечание:** Убедитесь что PostgreSQL запущен и доступен по указанным в `.env` параметрам.

---

⭐ **Если проект вам понравился, поставьте звездочку на GitHub!** ⭐