services:
  postgres-prod:
    image: postgres:15-alpine
    container_name: health_tracker_postgres_prod
    restart: unless-stopped
    env_file:
      - .env.production
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data

  api-prod:
    build:
      context: .
      dockerfile: Dockerfile.api  # Используем отдельный Dockerfile
    container_name: health_tracker_api_prod
    restart: unless-stopped
    env_file:
      - .env.production
    depends_on:
      - postgres-prod
    environment:
      POSTGRES_HOST: postgres-prod
      API_BASE_URL: http://localhost:8000
      # Proxy настройки для исходящего трафика через Xray
      HTTP_PROXY: http://host.docker.internal:10801
      HTTPS_PROXY: http://host.docker.internal:10801
      http_proxy: http://host.docker.internal:10801
      https_proxy: http://host.docker.internal:10801
      N8N_PROXY_HTTP: http://host.docker.internal:10801
      N8N_PROXY_HTTPS: http://host.docker.internal:10801
      NO_PROXY: localhost,127.0.0.1,postgres,172.0.0.0/8,10.0.0.0/8,192.168.0.0/16
      no_proxy: localhost,127.0.0.1,postgres,172.0.0.0/8,10.0.0.0/8,192.168.0.0/16
    ports:
      - "8000:8000"
    volumes:
      - ./app:/app/app
      - ./migrations:/app/migrations
      - ./main.py:/app/main.py

  bot-prod:
    build:
      context: .
      dockerfile: Dockerfile.bot  # Используем отдельный Dockerfile
    container_name: health_tracker_bot_prod
    restart: unless-stopped
    env_file:
      - .env.production
    depends_on:
      - api-prod
    environment:
      API_BASE_URL: http://api-prod:8000
    volumes:
      - ./bot:/app/bot
      - ./app/api_client.py:/app/api_client.py

  pgadmin-prod:
    image: dpage/pgadmin4
    container_name: health_tracker_pgadmin_prod
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
    ports:
      - "${PGADMIN_PORT}:80"
    volumes:
      - pgadmin_data_prod:/var/lib/pgadmin

volumes:
  postgres_data_prod:
  pgadmin_data_prod: