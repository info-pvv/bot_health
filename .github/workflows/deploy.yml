# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
    
    - name: Test SSH connection
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "echo '‚úÖ SSH connection successful'"
    
    - name: Deploy to server
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} '
          set -e
          echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π..."
          
          echo "üìÇ –ü–µ—Ä–µ—Ö–æ–∂—É –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞"
          cd /opt/health-tracker || {
            echo "‚ùå –ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –°–æ–∑–¥–∞—é..."
            mkdir -p /opt/health-tracker
            cd /opt/health-tracker
          }
          
          # –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –ø—É—Å—Ç–∞—è, –∫–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
          if [ ! -d ".git" ]; then
            echo "üîÑ –ö–ª–æ–Ω–∏—Ä—É—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          echo "üîÑ –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
          git pull origin main
          
          echo "üê≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ docker-compose —Ñ–∞–π–ª–∞
          if [ -f "docker-compose.prod.yml" ]; then
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build
          else
            echo "‚ö†Ô∏è docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          fi
          
          echo "üßπ –û—á–∏—â–∞—é —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã"
          docker system prune -f
          
          echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        '