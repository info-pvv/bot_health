name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted  # –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server
      run: |
        cd /opt/health-tracker || {
          echo "üìÅ –°–æ–∑–¥–∞—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
          sudo mkdir -p /opt/health-tracker
          sudo chown $USER:$USER /opt/health-tracker
          cd /opt/health-tracker
        }
        
        # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if [ ! -d ".git" ]; then
          echo "üîÑ –ö–ª–æ–Ω–∏—Ä—É—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
          git clone https://github.com/info-pvv/bot_health.git .
        fi
        
        echo "üîÑ –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥"
        git pull origin main
        
        echo "üê≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
        docker-compose -f docker-compose.prod.yml down
        docker-compose -f docker-compose.prod.yml up -d --build
        
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"