name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Fix git safe directory
      run: |
        git config --global --add safe.directory /opt/health-tracker || true
        git config --global --add safe.directory /opt/actions-runner/_work/bot_health/bot_health || true
    
    - name: Deploy to server
      run: |
        cd /opt/health-tracker || {
          echo "üìÅ –°–æ–∑–¥–∞—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
          sudo mkdir -p /opt/health-tracker
          sudo chown $USER:$USER /opt/health-tracker
          cd /opt/health-tracker
        }
        
        # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if [ ! -d ".git" ]; then
          echo "üîÑ –ö–ª–æ–Ω–∏—Ä—É—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
          git clone https://github.com/info-pvv/bot_health.git .
        else
          echo "üîÑ –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥"
          # –°–Ω–æ–≤–∞ –¥–æ–±–∞–≤–ª—è–µ–º safe.directory –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
          git config --global --add safe.directory /opt/health-tracker
          git pull origin main
        fi
        
        echo "üê≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
        if [ -f "docker compose.prod.yml" ]; then
          docker-compose -f docker compose.prod.yml down
          docker-compose -f docker compose.prod.yml up -d --build
        else
          echo "‚ö†Ô∏è docker compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          ls -la
        fi
        
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"