# .github/workflows/windows-ci.yml
name: Windows CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-asyncio  # —É–±–µ–¥–∏–º—Å—è —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    
    - name: Create test env file
      run: |
        @"
        POSTGRES_USER=test_user
        POSTGRES_PASSWORD=test_password
        POSTGRES_HOST=localhost
        POSTGRES_PORT=5432
        POSTGRES_DB=test_db
        TELEGRAM_TOKEN=1234567890:test_token
        SECRET_KEY=test_secret_key_123456
        API_V1_PREFIX=/api/v1
        PROJECT_NAME=Health Tracker Test
        ENVIRONMENT=test
        "@ | Out-File -FilePath .env.test -Encoding utf8
    
    #- name: Run tests
    #  run: |
    #    if (Test-Path tests/) {
    #      Write-Host "üß™ –ó–∞–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç—ã..."
    #      # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.test
    #      if (Test-Path .env.test) {
    #        Get-Content .env.test | ForEach-Object {
    #          if ($_ -match '^([^#=]+)=(.*)$') {
    #            [Environment]::SetEnvironmentVariable($matches[1], $matches[2])
    #          }
    #        }
    #      }
    #      python -m pytest tests/ -v
    #    } else {
    #      Write-Host "‚ö†Ô∏è –ü–∞–ø–∫–∞ tests/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç—ã"
    #    }
    #  shell: pwsh
    - name: Run tests (disabled for now)
      run: |
        Write-Host "‚ö†Ô∏è –¢–µ—Å—Ç—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã"
      shell: pwsh
    - name: Check code style
      run: |
        pip install black flake8
        Write-Host "üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞..."
        black --check app/ bot/ --diff || Write-Host "‚ö†Ô∏è Black –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—ã"
        flake8 app/ bot/ --count --select=E9,F63,F7,F82 --show-source --statistics || Write-Host "‚ö†Ô∏è Flake8 –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—ã"
      shell: pwsh

  build-docker:
    runs-on: windows-latest
    needs: test-windows
    if: always()  # –ó–∞–ø—É—Å–∫–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        docker build -t health-tracker:latest .
    
    - name: Save Docker image
      run: |
        docker save health-tracker:latest -o health-tracker.tar
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4  
      with:
        name: docker-image
        path: health-tracker.tar
        retention-days: 5  
        if-no-files-found: warn  