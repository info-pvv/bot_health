# .github/workflows/windows-ci.yml
name: Windows CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests (if exist)
      run: |
        if (Test-Path tests/) {
          Write-Host "üß™ –ó–∞–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç—ã..."
          python -m pytest tests/ -v
        } else {
          Write-Host "‚ö†Ô∏è –ü–∞–ø–∫–∞ tests/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç—ã"
        }
      shell: pwsh
    
    - name: Check code style
      run: |
        pip install black flake8
        Write-Host "üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞..."
        black --check app/ bot/ || Write-Host "‚ö†Ô∏è Black –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
        flake8 app/ bot/ --count --select=E9,F63,F7,F82 --show-source --statistics || Write-Host "‚ö†Ô∏è Flake8 –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
      shell: pwsh

  build-docker:
    runs-on: windows-latest
    needs: test-windows
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        docker build -t health-tracker:latest .
    
    - name: Save Docker image
      run: |
        docker save health-tracker:latest -o health-tracker.tar
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: health-tracker.tar