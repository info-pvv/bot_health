name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: üß™ Tests
    runs-on: windows-latest
    outputs:
      tests_passed: ${{ steps.run-tests.outcome }}
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - run: pip install -r requirements.txt
    
    - name: Run tests
      id: run-tests
      run: |
        if (Test-Path tests/) {
          pytest tests/ -v --junitxml=test-results.xml
        } else {
          Write-Host "‚ö†Ô∏è No tests found"
        }
      shell: pwsh
      continue-on-error: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results.xml
    
    - name: Check test status
      if: steps.run-tests.outcome != 'success' && steps.run-tests.outcome != 'skipped'
      run: exit 1

  deploy:
    name: üöÄ Deploy
    runs-on: self-hosted
    needs: test
    if: github.ref == 'refs/heads/main' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy
      run: |
        set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
        
        cd /opt/health-tracker
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        if [ ! -d ".git" ]; then
          echo "‚ùå –ù–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"
          exit 1
        fi
        
        if [ ! -f "docker-compose.prod.yml" ]; then
          echo "‚ùå –ù–µ—Ç docker-compose.prod.yml!"
          exit 1
        fi
        
        echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π..."
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
        sudo git fetch origin main
        sudo git reset --hard origin/main
        
        # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        sudo docker compose -f docker-compose.prod.yml down
        sudo docker compose -f docker-compose.prod.yml up -d --build
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞
        sleep 5
        if ! sudo docker compose -f docker-compose.prod.yml ps | grep -q "Up"; then
          echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å!"
          sudo docker compose -f docker-compose.prod.yml logs
          exit 1
        fi
        
        echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!"